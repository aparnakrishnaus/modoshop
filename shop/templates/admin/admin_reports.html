{% extends "admin_base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}

<style>
.filter-form-inline {
    display: flex;
    align-items: center;
    gap: 8px;
}
.filter-select-inline {
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    background: transparent;
    color: inherit;
    outline: none;
}
.filter-btn-inline {
    padding: 5px 12px;
    border: 1px solid #007bff;
    border-radius: 4px;
    background: transparent;
    color: #007bff;
    font-size: 14px;
    cursor: pointer;
}
.filter-btn-inline:hover {
    background: #007bff;
    color: #fff;
}
</style>

<div class="container mt-4">
    <h2 class="mb-2">Admin Reports</h2>

    <!-- Buttons -->
    <div class="d-flex mb-2 mt-3 w-25">
        <button id="btnExcel" class="btn btn-success me-2"><i class="fas fa-file-excel"></i> Excel</button>
        <button id="btnPDF" class="btn btn-danger me-2"><i class="fas fa-file-pdf"></i> PDF</button>
        <button id="btnPrint" class="btn btn-primary"><i class="fas fa-print"></i> Print</button>
    </div>

    <!-- Filter -->
    <form method="get" class="filter-form-inline mb-3 bg-transparent shadow-none">
        <select name="filter" class="filter-select-inline border border-dark"onchange="this.form.submit()">
            <option value="orders" {% if filter == 'orders' %}selected{% endif %}>Orders</option>
            <option value="payments" {% if filter == 'payments' %}selected{% endif %}>Payments</option>
            <option value="users" {% if filter == 'users' %}selected{% endif %}>Users</option>
            <option value="products" {% if filter == 'products' %}selected{% endif %}>Products</option>
            <option value="categories" {% if filter == 'categories' %}selected{% endif %}>Categories</option>
        </select>

        <!-- DATE FILTERS -->
    <input type="date" name="from_date" value="{{ from_date }}" class="filter-select-inline border border-dark">
    <input type="date" name="to_date" value="{{ to_date }}" class="filter-select-inline border border-dark">

        <button type="submit" class="filter-btn-inline bg-primary text-light">Filter</button>

         <a href="{% url 'admin_reports' %}"
       class="btn btn-secondary btn-sm ms-2">
        Reset
    </a>
    </form>

    <!-- Table -->
    <table class="table table-striped table-bordered" id="reportTable">
        <thead class="table-dark">
            <tr>
                {% if filter == 'orders' %}
                    <th>#</th><th>Order ID</th><th>User</th><th>Date</th><th>Total Amount</th><th>Status</th><th>Date</th>
                {% elif filter == 'payments' %}
                    <th>#</th><th>Payment ID</th><th>User</th><th>Date</th><th>Amount</th><th>Method</th><th>Status</th>
                {% elif filter == 'users' %}
                    <th>#</th><th>Username</th><th>Date</th><th>Email</th><th>Date Joined</th>
                {% elif filter == 'products' %}
                    <th>#</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th>
                {% elif filter == 'categories' %}
                    <th>#</th><th>Name</th><th>Total Products</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                {% if filter == 'orders' %}
                    <td>{{ forloop.counter }}</td><td>{{ item.id }}</td><td>{{ item.user.username }}</td><td>{{ item.created_at|date:"d M Y, h:i A" }}</td><td>{{ item.total_price }}</td><td>{{ item.status }}</td><td>{{ item.created_at|date:"d M Y, h:i A" }}</td>
                {% elif filter == 'payments' %}
                    <td>{{ forloop.counter }}</td><td>{{ item.id }}</td><td>{{ item.order.user.username }}</td> <td>
            {% if item.paid_at %}
                {{ item.paid_at|date:"d M Y, h:i A" }}
            {% else %}
                â€”
            {% endif %}
        </td><td>{{ item.amount }}</td><td>{{ item.method }}</td>
                    <td>
                        <span class="status {% if item.is_paid %}Completed{% else %}Pending{% endif %}">{% if item.is_paid %}Paid{% else %}Pending{% endif %}</span>
                    </td>
                {% elif filter == 'users' %}
                    <td>{{ forloop.counter }}</td><td>{{ item.username }}</td><td>{{ item.date_joined|date:"d M Y" }}</td><td>{{ item.email }}</td><td>{{ item.date_joined|date:"d M Y" }}</td>
                {% elif filter == 'products' %}
                    <td>{{ forloop.counter }}</td><td>{{ item.name }}</td><td>{{ item.category.name }}</td><td>{{ item.price }}</td><td>{{ item.stock }}</td>
                {% elif filter == 'categories' %}
                    <td>{{ forloop.counter }}</td><td>{{ item.name }}</td><td>{{ item.products.count }}</td>
                {% endif %}
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center">No data found</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.2/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>


<script>
function exportExcel() {
    let table = document.getElementById('reportTable');
    let wb = XLSX.utils.table_to_book(table, {sheet: "Report"});
    XLSX.writeFile(wb, 'Admin_Report.xlsx');
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF('landscape');
    doc.autoTable({ html: '#reportTable', startY: 10, styles: { fontSize: 10 } });
    doc.save('Admin_Report.pdf');
}

function printTable() {
    let divToPrint = document.getElementById('reportTable');
    let newWin = window.open('', '_blank');
    newWin.document.write('<html><head><title>Admin Report</title></head><body>');
    newWin.document.write(divToPrint.outerHTML);
    newWin.document.write('</body></html>');
    newWin.document.close();
    newWin.print();
}

document.getElementById('btnExcel').addEventListener('click', exportExcel);
document.getElementById('btnPDF').addEventListener('click', exportPDF);
document.getElementById('btnPrint').addEventListener('click', printTable);
</script>


{% endblock %}
